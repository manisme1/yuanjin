<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>源晶预约表</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.table-container { overflow-x: auto; }
.stats-table { border-collapse: collapse; width:100%; }
.stats-table th, .stats-table td { border:1px solid #ddd; padding:6px; text-align:center; white-space:nowrap; }
.stats-table th { background:#f2f2f2; font-weight:bold; }
.reserved { background:#d4edda; font-weight:bold; }
</style>
</head>
<body class="bg-gray-100">

<div id="app" class="p-4 max-w-7xl mx-auto">
  <!-- 成员预约页 -->
  <div id="member-page">
    <div class="bg-white p-5 rounded shadow mb-4">
      <h2 class="font-bold mb-3">源晶预约</h2>
      <div class="mb-2">
        <label>你的名字</label>
        <input id="quick-name" class="w-full border p-2 rounded" placeholder="请输入名字">
      </div>
      <div class="mb-2">
        <label>源晶等级</label>
        <select id="crystal-level" onchange="renderCrystalAttr()" class="w-full border p-2 rounded">
          <option value="">请选择等级</option>
          <option value="橙">橙</option>
          <option value="红">红</option>
          <option value="彩">彩</option>
        </select>
      </div>
      <div class="mb-2">
        <label>源晶属性</label>
        <select id="crystal-attr" class="w-full border p-2 rounded">
          <option value="">请先选择等级</option>
        </select>
      </div>
      <div class="mb-2">
        <label>预约日期</label>
        <input type="date" id="quick-date" class="w-full border p-2 rounded">
      </div>
      <button onclick="quickSubmit()" class="bg-blue-500 text-white p-2 rounded w-full">提交预约</button>
      <button onclick="showAdminLogin()" class="mt-2 text-blue-600 text-sm">管理员登录</button>
    </div>
  </div>

  <!-- 管理员登录页 -->
  <div id="admin-login" class="hidden bg-white p-5 rounded shadow">
    <h3 class="font-bold mb-2">管理员登录</h3>
    <input id="admin-user" class="w-full border p-2 rounded mb-2" placeholder="用户名">
    <input type="password" id="admin-pwd" class="w-full border p-2 rounded mb-2" placeholder="密码">
    <button onclick="adminLogin()" class="bg-blue-500 text-white p-2 rounded w-full">登录</button>
    <button onclick="backToMember()" class="mt-2 text-sm">返回预约</button>
  </div>

  <!-- 管理员后台 -->
  <div id="admin-panel" class="hidden">
    <!-- 预约管理 -->
    <div class="bg-white p-5 rounded shadow mb-4">
      <div class="flex justify-between">
        <h3 class="font-bold">预约管理</h3>
        <button onclick="logout()" class="text-red-500 text-sm">退出登录</button>
      </div>
      <div class="grid grid-cols-6 gap-2 font-bold mt-2">
        <div>预约人</div><div>等级</div><div>属性</div><div>日期</div><div>状态</div><div>操作</div>
      </div>
      <div id="list" class="mt-2 space-y-2"></div>
    </div>

    <!-- 统计表格 -->
    <div class="bg-white p-5 rounded shadow mb-4">
      <h3 class="font-bold mb-3">源晶预约表格</h3>
      <p class="text-sm mb-2">同一行 = 同一轮，从上到下 = 预约先后</p>
      <div class="table-container">
        <table id="stats-table" class="stats-table"></table>
      </div>
    </div>

    <!-- 最高权限专属：用户管理 -->
    <div id="user-manager" class="bg-white p-5 rounded shadow">
      <h4 class="font-bold mb-2">用户管理（最高权限）</h4>
      <div id="user-list" class="space-y-1 mb-3"></div>
      <input id="new-user" class="w-full border p-2 rounded mb-1" placeholder="新用户名">
      <input id="new-pwd" class="w-full border p-2 rounded mb-1" placeholder="新密码">
      <select id="new-role" class="w-full border p-2 rounded mb-2">
        <option value="admin">管理员</option>
        <option value="super">最高权限</option>
      </select>
      <button onclick="addUser()" class="bg-green-500 text-white p-2 rounded w-full">添加账号</button>
    </div>
  </div>
</div>

<script>
let currentAdmin = null;

// ========== 核心修复：强制重置账号，覆盖旧缓存 ==========
// 1. 先清空旧的管理员缓存
localStorage.removeItem("adminUsers");
// 2. 强制设置你要的账号，不再读取旧缓存
let users = [
  { username: "740780", password: "mxm740780", role: "super" },   // 最高权限（你的账号）
  { username: "admin", password: "123456", role: "admin" }       // 普通管理员（备用）
];
// 3. 把新账号写入本地存储，永久生效
localStorage.setItem("adminUsers", JSON.stringify(users));

// 预约数据（保留原有逻辑）
let reservationList = JSON.parse(localStorage.getItem("yuanjingReserve")) || [];

// 完整源晶属性列表
const crystalAttrs = [
  "能量","格挡","生命","命中","破档","攻击",
  "宇宙人攻击","怪兽攻击","奥攻击","机械攻击",
  "闪避","宇宙人生命","怪兽生命","奥生命","机械生命","暴击"
];

// 保存用户数据到本地存储
function saveUsers() {
  localStorage.setItem("adminUsers", JSON.stringify(users));
}

// 渲染源晶属性下拉框
function renderCrystalAttr() {
  const level = document.getElementById("crystal-level").value;
  const attrSelect = document.getElementById("crystal-attr");
  attrSelect.innerHTML = "";
  
  if (!level) {
    attrSelect.innerHTML = '<option value="">请先选择等级</option>';
    return;
  }
  
  crystalAttrs.forEach(attr => {
    const option = document.createElement("option");
    option.value = attr;
    option.textContent = attr;
    attrSelect.appendChild(option);
  });
}

// 提交预约（核心：校验单个成员不能重复预约同一源晶）
function quickSubmit() {
  const name = document.getElementById("quick-name").value.trim();
  const level = document.getElementById("crystal-level").value;
  const attr = document.getElementById("crystal-attr").value;
  const date = document.getElementById("quick-date").value;

  // 基础校验
  if (!name) return alert("请输入你的名字！");
  if (!level) return alert("请选择源晶等级！");
  if (!attr) return alert("请选择源晶属性！");
  if (!date) return alert("请选择预约日期！");

  // 关键校验：当前成员是否已经预约过该源晶（不管状态，只要约过就不能再约）
  const isDuplicate = reservationList.some(r => 
    r.name === name && r.level === level && r.attr === attr
  );
  
  if (isDuplicate) {
    return alert(`你已经预约过【${level}${attr}】，不能重复预约！`);
  }

  // 添加预约记录
  reservationList.push({
    id: Date.now(),
    name: name,
    level: level,
    attr: attr,
    date: date,
    status: "待审核",
    submitTime: Date.now()
  });

  // 保存到本地存储
  localStorage.setItem("yuanjingReserve", JSON.stringify(reservationList));
  alert("预约提交成功！");

  // 清空表单
  document.getElementById("quick-name").value = "";
  document.getElementById("crystal-level").value = "";
  document.getElementById("crystal-attr").innerHTML = '<option value="">请先选择等级</option>';
  document.getElementById("quick-date").value = "";
}

// 显示管理员登录页
function showAdminLogin() {
  document.getElementById("member-page").classList.add("hidden");
  document.getElementById("admin-login").classList.remove("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
}

// 返回成员预约页
function backToMember() {
  document.getElementById("member-page").classList.remove("hidden");
  document.getElementById("admin-login").classList.add("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
}

// 管理员登录
function adminLogin() {
  const username = document.getElementById("admin-user").value.trim();
  const password = document.getElementById("admin-pwd").value.trim();
  
  const user = users.find(u => u.username === username && u.password === password);
  if (!user) return alert("用户名或密码错误！");

  currentAdmin = user;
  document.getElementById("admin-login").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  
  // 渲染数据
  renderReservationList();
  renderUserList();
  renderStatsTable();
}

// 渲染预约列表
function renderReservationList() {
  const listDom = document.getElementById("list");
  listDom.innerHTML = "";

  if (reservationList.length === 0) {
    listDom.innerHTML = '<div class="py-3 text-center text-gray-500">暂无预约记录</div>';
    return;
  }

  reservationList.forEach(item => {
    const itemDom = document.createElement("div");
    itemDom.className = "grid grid-cols-6 gap-2 items-center border-b pb-1";
    itemDom.innerHTML = `
      <div>${item.name}</div>
      <div>${item.level}</div>
      <div>${item.attr}</div>
      <div>${item.date}</div>
      <div>${item.status}</div>
      <div>
        <button onclick="updateStatus(${item.id}, '已通过')" class="text-green-600 text-xs mr-1">通过</button>
        <button onclick="updateStatus(${item.id}, '已拒绝')" class="text-red-600 text-xs mr-1">拒绝</button>
        <button onclick="deleteReservation(${item.id})" class="text-gray-500 text-xs">删除</button>
      </div>
    `;
    listDom.appendChild(itemDom);
  });
}

// 渲染用户列表（最高权限专属）
function renderUserList() {
  const userListDom = document.getElementById("user-list");
  userListDom.innerHTML = "";

  users.forEach(user => {
    const userDom = document.createElement("div");
    userDom.className = "p-2 border rounded flex justify-between";
    userDom.innerHTML = `
      <div>${user.username} (${user.role === 'super' ? '最高权限' : '普通管理员'})</div>
      <button onclick="deleteUser('${user.username}')" class="text-red-500 text-xs">删除</button>
    `;
    userListDom.appendChild(userDom);
  });
}

// 核心：渲染预约表格（同一轮同一行，从上到下按预约顺序）
function renderStatsTable() {
  const tableDom = document.getElementById("stats-table");
  tableDom.innerHTML = "";

  // 只显示已通过的预约，按提交时间排序
  const approvedList = reservationList
    .filter(r => r.status === "已通过")
    .sort((a, b) => a.submitTime - b.submitTime);

  // 构建表头
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  ["橙","红","彩"].forEach(level => {
    crystalAttrs.forEach(attr => {
      const th = document.createElement("th");
      th.textContent = level + attr;
      headerRow.appendChild(th);
    });
  });
  thead.appendChild(headerRow);
  tableDom.appendChild(thead);

  // 按列收集预约数据（每列一个源晶，从上到下是预约顺序）
  const columnData = {};
  ["橙","红","彩"].forEach(level => {
    crystalAttrs.forEach(attr => {
      const key = level + attr;
      columnData[key] = approvedList.filter(r => r.level === level && r.attr === attr);
    });
  });

  // 计算最大行数（避免空行）
  const maxRows = Math.max(...Object.values(columnData).map(col => col.length), 0);
  
  if (maxRows === 0) {
    tableDom.innerHTML += '<tr><td colspan="48" class="py-3 text-gray-500">暂无已通过的预约记录</td></tr>';
    return;
  }

  // 渲染表格行
  const tbody = document.createElement("tbody");
  for (let i = 0; i < maxRows; i++) {
    const row = document.createElement("tr");
    ["橙","红","彩"].forEach(level => {
      crystalAttrs.forEach(attr => {
        const key = level + attr;
        const td = document.createElement("td");
        
        // 取当前行的预约记录
        const record = columnData[key][i];
        if (record) {
          td.textContent = record.name;
          td.className = "reserved";
        }
        
        row.appendChild(td);
      });
    });
    tbody.appendChild(row);
  }
  tableDom.appendChild(tbody);
}

// 更新预约状态
function updateStatus(id, status) {
  const index = reservationList.findIndex(r => r.id === id);
  if (index === -1) return;
  
  reservationList[index].status = status;
  localStorage.setItem("yuanjingReserve", JSON.stringify(reservationList));
  
  renderReservationList();
  renderStatsTable();
}

// 删除预约记录
function deleteReservation(id) {
  if (!confirm("确定要删除这条预约记录吗？删除后不可恢复！")) return;
  
  reservationList = reservationList.filter(r => r.id !== id);
  localStorage.setItem("yuanjingReserve", JSON.stringify(reservationList));
  
  renderReservationList();
  renderStatsTable();
}

// 添加用户（最高权限专属）
function addUser() {
  // 只有最高权限能添加账号
  if (currentAdmin.role !== "super") {
    return alert("只有最高权限账号才能添加用户！");
  }

  const username = document.getElementById("new-user").value.trim();
  const password = document.getElementById("new-pwd").value.trim();
  const role = document.getElementById("new-role").value;

  if (!username || !password) return alert("请输入用户名和密码！");
  if (users.some(u => u.username === username)) return alert("该用户名已存在！");

  // 添加新用户
  users.push({ username, password, role });
  saveUsers();
  renderUserList();

  alert("账号添加成功！");
  document.getElementById("new-user").value = "";
  document.getElementById("new-pwd").value = "";
}

// 删除用户（最高权限专属）
function deleteUser(username) {
  // 只有最高权限能删除账号
  if (currentAdmin.role !== "super") {
    return alert("只有最高权限账号才能删除用户！");
  }

  // 不能删除当前登录的账号
  if (username === currentAdmin.username) {
    return alert("不能删除当前登录的账号！");
  }

  if (!confirm(`确定要删除用户【${username}】吗？`)) return;

  users = users.filter(u => u.username !== username);
  saveUsers();
  renderUserList();
}

// 退出登录
function logout() {
  currentAdmin = null;
  backToMember();
}
</script>
</body>
</html>